# PKOPT4B: cov-empty AllSub window probing (ribo-benchmark)

This note documents a small top-K selection tweak aimed at improving **pseudoknot** discovery when
CaCoFold covariation provides no usable pairs (`cov_empty`).

## Change summary

File: `benchmark_runner/src/ssbench/predict/cacofold_mcmc_pipeline.py`

When enforcing a reserved quota of AllSub-derived structures in the final top-K list:

- **Early reserved quota (cov-empty only):** keep a mid-depth AllSub band (`seed_order≈80–140`) in
  the early probe set so it can land inside `@200`/`@500` instead of being pushed out by head/tail
  alternation.
- **Reserved quota fill (cov-empty only):** build a probe list from **contiguous seed-order windows**
  around several quantiles (`~3%,10%,50%,75%,90%`), then iterate that probe **in-order** (instead of
  alternating ends) so deep-but-good AllSub candidates can appear before the top-500 cutoff.

This is **not** dual-penalty sampling; it only changes how we choose which AllSub structures to
keep when we must allocate a fixed AllSub quota inside the final top-K.

## Why this can help PK sampling

In the `cov_empty` regime, CaCoFold provides an alignment/consensus scaffold, but the `.cov` file
does not contribute any mapped covariation pairs. In this setting, PK-rich candidates often come
from the *scaffold backends* (AllSub-like sampling), and good PK seeds sometimes appear at
intermediate depth in the AllSub order.

The previous “alternate ends” probing could over-sample the head and extreme tail, pushing some
mid-depth candidates past `@200`/`@500`. Window probing increases the chance that a mid-depth PK seed
survives into the final ranked prefix.

## Results (ribo-benchmark oracle best-of-K)

Target: `rna_sets/ribo-benchmark` (N=16), oracle best-of-K over `K ∈ {1,50,100,200,500}`.

Mean oracle F1/MCC:

- `@1`   RN (pkopt4b) `0.729/0.733` | RN (opt6) `0.729/0.733` | EF `0.598/0.596` | LF `0.747/0.750`
- `@50`  RN (pkopt4b) `0.842/0.844` | RN (opt6) `0.844/0.846` | EF `0.838/0.839` | LF `0.838/0.840`
- `@100` RN (pkopt4b) `0.849/0.851` | RN (opt6) `0.848/0.851` | EF `0.848/0.849` | LF `0.847/0.848`
- `@200` RN (pkopt4b) `0.854/0.856` | RN (opt6) `0.856/0.858` | EF `0.861/0.863` | LF `0.853/0.854`
- `@500` RN (pkopt4b) `0.871/0.872` | RN (opt6) `0.867/0.868` | EF `0.871/0.872` | LF `0.860/0.861`

Per-RNA changes at `@500` (RN pkopt4b vs RN opt6):

- `4YAZ` improves `0.780488 → 0.837209` (ΔF1 `+0.056721`)
- `6WJR` improves `0.807018 → 0.836364` (ΔF1 `+0.029346`)
- `6UBU` regresses `0.930233 → 0.909091` (ΔF1 `-0.021142`)

### Per-RNA F1/MCC tables

Each cell is `F1/MCC`, oracle best within the first `K` structures.

#### @1

| RNA | L | RN (pkopt4b) F1/MCC | RN (opt6) F1/MCC | EF F1/MCC | LF F1/MCC |
|---:|---:|---:|---:|---:|---:|
| 2MXS | 27 | 0.875/0.879 | 0.875/0.879 | 0.375/0.364 | 0.933/0.934 |
| 3Q3Z | 75 | 0.490/0.490 | 0.490/0.490 | 0.524/0.520 | 0.533/0.531 |
| 4NYA | 80 | 0.792/0.793 | 0.792/0.793 | 0.750/0.752 | 0.809/0.809 |
| 4RUM | 92 | 0.900/0.900 | 0.900/0.900 | 0.931/0.931 | 0.949/0.949 |
| 4YAZ | 84 | 0.667/0.665 | 0.667/0.665 | 0.429/0.427 | 0.609/0.606 |
| 6C27 | 47 | 0.600/0.607 | 0.600/0.607 | 0.714/0.718 | 0.741/0.742 |
| 6CB3 | 99 | 0.938/0.939 | 0.938/0.939 | 0.931/0.931 | 0.780/0.778 |
| 6DLQ | 107 | 0.847/0.848 | 0.847/0.848 | 0.714/0.713 | 0.759/0.758 |
| 6E1W | 30 | 0.667/0.675 | 0.667/0.675 | 0.833/0.831 | 0.909/0.912 |
| 6N2V | 98 | 0.847/0.853 | 0.847/0.853 | 0.528/0.526 | 0.847/0.853 |
| 6Q57 | 89 | 0.526/0.527 | 0.526/0.527 | 0.000/-0.006 | 0.536/0.536 |
| 6QN3 | 50 | 0.640/0.683 | 0.640/0.683 | 0.381/0.387 | 0.696/0.728 |
| 6TFF | 52 | 0.833/0.831 | 0.833/0.831 | 0.606/0.604 | 0.857/0.856 |
| 6UBU | 67 | 0.818/0.816 | 0.818/0.816 | 0.800/0.802 | 0.821/0.826 |
| 6VMY | 148 | 0.561/0.562 | 0.561/0.562 | 0.308/0.306 | 0.545/0.544 |
| 6WJR | 111 | 0.656/0.655 | 0.656/0.655 | 0.737/0.736 | 0.633/0.632 |
| **mean** | - | **0.729/0.733** | **0.729/0.733** | **0.598/0.596** | **0.747/0.750** |

#### @50

| RNA | L | RN (pkopt4b) F1/MCC | RN (opt6) F1/MCC | EF F1/MCC | LF F1/MCC |
|---:|---:|---:|---:|---:|---:|
| 2MXS | 27 | 0.933/0.934 | 0.933/0.934 | 0.933/0.934 | 0.933/0.934 |
| 3Q3Z | 75 | 0.632/0.633 | 0.585/0.582 | 0.632/0.633 | 0.571/0.568 |
| 4NYA | 80 | 0.933/0.933 | 0.933/0.933 | 0.909/0.908 | 0.933/0.933 |
| 4RUM | 92 | 0.983/0.983 | 0.966/0.965 | 0.983/0.983 | 0.966/0.965 |
| 4YAZ | 84 | 0.750/0.749 | 0.769/0.781 | 0.750/0.749 | 0.744/0.744 |
| 6C27 | 47 | 0.857/0.864 | 0.857/0.864 | 0.857/0.864 | 0.857/0.864 |
| 6CB3 | 99 | 0.952/0.953 | 0.952/0.953 | 0.968/0.968 | 0.968/0.968 |
| 6DLQ | 107 | 0.868/0.869 | 0.847/0.848 | 0.868/0.869 | 0.828/0.827 |
| 6E1W | 30 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 |
| 6N2V | 98 | 0.897/0.901 | 0.897/0.901 | 0.877/0.880 | 0.897/0.901 |
| 6Q57 | 89 | 0.642/0.640 | 0.708/0.707 | 0.640/0.638 | 0.727/0.728 |
| 6QN3 | 50 | 0.842/0.852 | 0.842/0.852 | 0.842/0.852 | 0.762/0.783 |
| 6TFF | 52 | 0.914/0.914 | 0.914/0.914 | 0.914/0.914 | 0.889/0.887 |
| 6UBU | 67 | 0.878/0.879 | 0.878/0.879 | 0.878/0.879 | 0.878/0.879 |
| 6VMY | 148 | 0.716/0.718 | 0.716/0.718 | 0.703/0.702 | 0.744/0.744 |
| 6WJR | 111 | 0.767/0.766 | 0.800/0.800 | 0.737/0.736 | 0.807/0.806 |
| **mean** | - | **0.842/0.844** | **0.844/0.846** | **0.838/0.839** | **0.838/0.840** |

#### @100

| RNA | L | RN (pkopt4b) F1/MCC | RN (opt6) F1/MCC | EF F1/MCC | LF F1/MCC |
|---:|---:|---:|---:|---:|---:|
| 2MXS | 27 | 0.933/0.934 | 0.933/0.934 | 0.933/0.934 | 0.933/0.934 |
| 3Q3Z | 75 | 0.632/0.633 | 0.612/0.615 | 0.632/0.633 | 0.571/0.568 |
| 4NYA | 80 | 0.933/0.933 | 0.933/0.933 | 0.913/0.913 | 0.933/0.933 |
| 4RUM | 92 | 0.983/0.983 | 0.966/0.965 | 0.983/0.983 | 0.966/0.965 |
| 4YAZ | 84 | 0.762/0.764 | 0.769/0.781 | 0.780/0.785 | 0.792/0.791 |
| 6C27 | 47 | 0.857/0.864 | 0.857/0.864 | 0.889/0.893 | 0.857/0.864 |
| 6CB3 | 99 | 0.952/0.953 | 0.952/0.953 | 0.968/0.968 | 0.968/0.968 |
| 6DLQ | 107 | 0.868/0.869 | 0.847/0.848 | 0.893/0.892 | 0.862/0.862 |
| 6E1W | 30 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 |
| 6N2V | 98 | 0.897/0.901 | 0.897/0.901 | 0.889/0.889 | 0.897/0.901 |
| 6Q57 | 89 | 0.741/0.741 | 0.741/0.741 | 0.640/0.638 | 0.741/0.741 |
| 6QN3 | 50 | 0.842/0.852 | 0.842/0.852 | 0.842/0.852 | 0.800/0.815 |
| 6TFF | 52 | 0.914/0.914 | 0.914/0.914 | 0.914/0.914 | 0.889/0.887 |
| 6UBU | 67 | 0.878/0.879 | 0.878/0.879 | 0.905/0.905 | 0.878/0.879 |
| 6VMY | 148 | 0.716/0.718 | 0.716/0.718 | 0.703/0.702 | 0.744/0.744 |
| 6WJR | 111 | 0.767/0.766 | 0.800/0.800 | 0.772/0.771 | 0.807/0.806 |
| **mean** | - | **0.849/0.851** | **0.848/0.851** | **0.848/0.849** | **0.847/0.848** |

#### @200

| RNA | L | RN (pkopt4b) F1/MCC | RN (opt6) F1/MCC | EF F1/MCC | LF F1/MCC |
|---:|---:|---:|---:|---:|---:|
| 2MXS | 27 | 1.000/1.000 | 1.000/1.000 | 0.933/0.934 | 0.933/0.934 |
| 3Q3Z | 75 | 0.632/0.633 | 0.615/0.615 | 0.632/0.633 | 0.571/0.568 |
| 4NYA | 80 | 0.933/0.933 | 0.933/0.933 | 0.913/0.913 | 0.933/0.933 |
| 4RUM | 92 | 0.983/0.983 | 0.983/0.983 | 0.983/0.983 | 0.966/0.965 |
| 4YAZ | 84 | 0.783/0.781 | 0.780/0.785 | 0.800/0.808 | 0.792/0.791 |
| 6C27 | 47 | 0.857/0.864 | 0.889/0.893 | 0.889/0.893 | 0.857/0.864 |
| 6CB3 | 99 | 0.952/0.953 | 0.952/0.953 | 0.984/0.984 | 0.968/0.968 |
| 6DLQ | 107 | 0.868/0.869 | 0.847/0.848 | 0.893/0.892 | 0.877/0.877 |
| 6E1W | 30 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 |
| 6N2V | 98 | 0.897/0.901 | 0.897/0.901 | 0.912/0.915 | 0.912/0.915 |
| 6Q57 | 89 | 0.741/0.741 | 0.741/0.741 | 0.739/0.740 | 0.741/0.741 |
| 6QN3 | 50 | 0.842/0.852 | 0.842/0.852 | 0.842/0.852 | 0.842/0.852 |
| 6TFF | 52 | 0.914/0.914 | 0.914/0.914 | 0.914/0.914 | 0.889/0.887 |
| 6UBU | 67 | 0.878/0.879 | 0.878/0.879 | 0.905/0.905 | 0.878/0.879 |
| 6VMY | 148 | 0.716/0.718 | 0.716/0.718 | 0.718/0.718 | 0.765/0.767 |
| 6WJR | 111 | 0.767/0.766 | 0.800/0.800 | 0.807/0.806 | 0.807/0.806 |
| **mean** | - | **0.854/0.856** | **0.856/0.858** | **0.861/0.863** | **0.853/0.854** |

#### @500

| RNA | L | RN (pkopt4b) F1/MCC | RN (opt6) F1/MCC | EF F1/MCC | LF F1/MCC |
|---:|---:|---:|---:|---:|---:|
| 2MXS | 27 | 1.000/1.000 | 1.000/1.000 | 1.000/1.000 | 0.933/0.934 |
| 3Q3Z | 75 | 0.632/0.633 | 0.632/0.633 | 0.632/0.633 | 0.585/0.582 |
| 4NYA | 80 | 0.933/0.933 | 0.933/0.933 | 0.933/0.933 | 0.933/0.933 |
| 4RUM | 92 | 0.983/0.983 | 0.983/0.983 | 0.983/0.983 | 0.983/0.983 |
| 4YAZ | 84 | 0.837/0.838 | 0.780/0.785 | 0.800/0.808 | 0.792/0.791 |
| 6C27 | 47 | 0.889/0.893 | 0.889/0.893 | 0.889/0.893 | 0.889/0.893 |
| 6CB3 | 99 | 0.984/0.984 | 0.984/0.984 | 0.984/0.984 | 0.968/0.968 |
| 6DLQ | 107 | 0.893/0.892 | 0.893/0.892 | 0.909/0.909 | 0.897/0.897 |
| 6E1W | 30 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 | 0.909/0.912 |
| 6N2V | 98 | 0.912/0.915 | 0.912/0.915 | 0.912/0.915 | 0.912/0.915 |
| 6Q57 | 89 | 0.741/0.741 | 0.741/0.741 | 0.792/0.791 | 0.776/0.774 |
| 6QN3 | 50 | 0.842/0.852 | 0.842/0.852 | 0.842/0.852 | 0.842/0.852 |
| 6TFF | 52 | 0.914/0.914 | 0.914/0.914 | 0.914/0.914 | 0.889/0.887 |
| 6UBU | 67 | 0.909/0.908 | 0.930/0.930 | 0.905/0.905 | 0.878/0.879 |
| 6VMY | 148 | 0.716/0.718 | 0.716/0.718 | 0.718/0.718 | 0.765/0.767 |
| 6WJR | 111 | 0.836/0.837 | 0.807/0.806 | 0.807/0.806 | 0.807/0.806 |
| **mean** | - | **0.871/0.872** | **0.867/0.868** | **0.871/0.872** | **0.860/0.861** |

## Reproduce

Generate predictions (from repo root):

```bash
export DATAPATH="$(pwd)/RNAstructure/data_tables"
out_root="out/ribo_benchmark_rnanneal_ss_top500_pkopt4b"
mkdir -p "$out_root"
for d in rna_sets/ribo-benchmark/*; do
  [ -d "$d" ] || continue
  r=$(basename "$d")
  rnanneal-ss "$d/$r.fasta" "$out_root/$r" --top-k 500
done
```

Optional: generate the opt6 baseline for A/B comparison (baseline commit: `b87c9a1`):

```bash
git checkout b87c9a1
export DATAPATH="$(pwd)/RNAstructure/data_tables"
out_root="out/ribo_benchmark_rnanneal_ss_top500_opt6"
mkdir -p "$out_root"
for d in rna_sets/ribo-benchmark/*; do
  [ -d "$d" ] || continue
  r=$(basename "$d")
  rnanneal-ss "$d/$r.fasta" "$out_root/$r" --top-k 500
done
git checkout main
```

Score oracle best-of-K and compare vs EF/LF:

- Use the scorer script in `docs/RIBO_BENCHMARK_ORACLE_TOPK.md`.
