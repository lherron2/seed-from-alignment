#!/usr/bin/env python3
from __future__ import annotations

import os
import re
import subprocess
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).resolve().parents[1]))
from _ct import CtStruct, write_ct  # noqa: E402
from _docker import docker_run_stream  # noqa: E402


def read_single_fasta(path: Path) -> tuple[str, str]:
    seq_id = "seq"
    seq_parts: list[str] = []
    for ln in path.read_text().splitlines():
        ln = ln.strip()
        if not ln:
            continue
        if ln.startswith(">"):
            seq_id = ln[1:].strip() or seq_id
            continue
        seq_parts.append(ln)
    return seq_id, "".join(seq_parts).upper().replace("T", "U")


def main(argv: list[str]) -> int:
    if len(argv) < 3:
        sys.stderr.write("USAGE: Fold <fasta> <out.ct> [options]\n")
        return 2
    fasta = Path(argv[1])
    out_ct = Path(argv[2])

    docker_image = (os.environ.get("LINEARFOLD_DOCKER_IMAGE") or "").strip()
    beamsize = int(os.environ.get("LINEARFOLD_BEAMSIZE", "100"))

    seq_id, seq = read_single_fasta(fasta)
    fasta_text = f">{seq_id}\n{seq}\n"
    if docker_image:
        rc, out = docker_run_stream(
            image=docker_image,
            args=["--fasta", "-V", "-b", str(beamsize)],
            stdin_text=fasta_text,
        )
    else:
        repo_root = Path(__file__).resolve().parents[4]
        linearfold = Path(
            os.environ.get("LINEARFOLD_BIN")
            or (repo_root / "external" / "LinearFold" / "linearfold")
        )
        proc = subprocess.run(
            [str(linearfold), "--fasta", "-V", "-b", str(beamsize)],
            input=fasta_text,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            check=False,
        )
        rc, out = int(proc.returncode), proc.stdout
    if rc != 0:
        sys.stderr.write(out)
        struct = "." * len(seq)
        energy = 0.0
    else:
        struct = "." * len(seq)
        energy = 0.0
        energy_re = re.compile(r"\(([-+]?\d+(?:\.\d+)?)\)")
        for line in out.splitlines():
            s = line.strip()
            if not s:
                continue
            tok = s.split()[0]
            if len(tok) != len(seq):
                continue
            if any(ch not in ".()[]{}<>" for ch in tok):
                continue
            struct = tok
            m = energy_re.search(s)
            energy = float(m.group(1)) if m else 0.0
            break

    out_ct.parent.mkdir(parents=True, exist_ok=True)
    write_ct(seq=seq, structs=[CtStruct(struct, energy, seq_id)], out_path=out_ct)
    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
